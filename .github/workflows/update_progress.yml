---
name: GitHub CLI Automation (No Azure)

on:
  schedule:
    - cron: "0 3 * * *" # Daily at 8:30 AM IST (3:00 AM UTC)

  workflow_dispatch:

  issues:
    types: [opened, closed, labeled]

  push:
    branches:
      - main

permissions:
  contents: write
  issues: write

jobs:
  update-progress:
    name: Update Learning Progress
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Count Completed Tasks
        id: count
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TOTAL=$(gh issue list --label "day-task" --state all --limit 1000 --json number | jq '. | length')
          CLOSED=$(gh issue list --label "day-task" --state closed --limit 1000 --json number | jq '. | length')

          if [ "$TOTAL" -gt 0 ]; then
            PERCENT=$((CLOSED * 100 / TOTAL))
          else
            PERCENT=0
          fi

          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"
          echo "closed=$CLOSED" >> "$GITHUB_OUTPUT"
          echo "percent=$PERCENT" >> "$GITHUB_OUTPUT"

      - name: Update README
        run: |
          sed -i "s|!\[Progress\](.*)|![Progress](https://img.shields.io/badge/Progress-${{ steps.count.outputs.percent }}%25-blue)|" README.md || true
          sed -i "s/Completed: [0-9]*\/[0-9]*/Completed: ${{ steps.count.outputs.closed }}\/${{ steps.count.outputs.total }}/" README.md || true

      - name: Commit Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add README.md
            git commit -m "Update progress: ${{ steps.count.outputs.closed }}/${{ steps.count.outputs.total }}"
            git push
          fi

  weekly-summary:
    name: Weekly Progress Summary
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Generate Weekly Report
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          WEEK_START=$(date -d "7 days ago" +%Y-%m-%d)
          WEEK_END=$(date +%Y-%m-%d)
          WEEK_NUM=$(date +%U)

          CLOSED_THIS_WEEK=$(gh issue list \
            --label "day-task" \
            --state closed \
            --search "closed:>=$WEEK_START" \
            --json number \
            --jq 'length')

          gh issue create \
            --title "ðŸ“Š Week ${WEEK_NUM} Summary" \
            --label "summary" \
            --body "$(cat <<EOF
## Weekly Progress Report

**Week of:** ${WEEK_START} to ${WEEK_END}

**Tasks Completed:** ${CLOSED_THIS_WEEK}

Keep up the great work! ðŸš€

---
This is an automated weekly summary.
EOF
)"