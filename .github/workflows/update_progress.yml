name: Update README progress

on:
  schedule:
    - cron: '0 */6 * * *' # every 6 hours
  workflow_dispatch:

permissions:
  contents: write
  issues: read

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Count day-task issues and update README
        uses: actions/github-script@v7
        with:
          script: |
            const label = "day-task";
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // list all issues with the label (open and closed)
            const per_page = 100;
            let page = 1;
            let issues = [];

            while (true) {
              const resp = await github.rest.issues.listForRepo({
                owner,
                repo,
                labels: label,
                state: "all",
                per_page,
                page
              });
              issues = issues.concat(resp.data);
              if (resp.data.length < per_page) break;
              page++;
            }

            const total = issues.length;
            const closed = issues.filter(i => i.state === "closed").length;
            const pct = total > 0 ? Math.floor((closed * 100) / total) : 0;

            core.info(`Found ${closed}/${total} closed (${pct}%)`);

            // Read README.md
            const fs = require('fs');
            const readmePath = 'README.md';
            let content = fs.readFileSync(readmePath, 'utf8');

            // Replace or add a Progress: line
            const newLine = `Progress: ${closed}/${total} (${pct}%)`;
            if (content.match(/^Progress:.*$/m)) {
              content = content.replace(/^Progress:.*$/m, newLine);
            } else {
              // add near top after first heading (or at start if not found)
              const firstHeading = content.indexOf('\n');
              if (firstHeading !== -1) {
                content = content.slice(0, firstHeading + 1) + newLine + '\n' + content.slice(firstHeading + 1);
              } else {
                content = newLine + '\n' + content;
              }
            }

            fs.writeFileSync(readmePath, content, 'utf8');

            // Commit back
            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path: 'README.md',
              message: `chore: update progress to ${pct}%`,
              content: Buffer.from(content, 'utf8').toString('base64'),
              sha: (await github.rest.repos.getContent({ owner, repo, path: 'README.md' })).data.sha
            });

          github-token: ${{ secrets.GITHUB_TOKEN }}